#!/usr/bin/env nix
#! nix develop ..
#! nix --extra-experimental-features ``nix-command flakes``
#! nix --command bash

set -exo pipefail

if [ "$#" -eq 0 ]; then
  echo "Usage: $0 hostname"
  exit 1
fi

hostname=$1
shift 1

# Store initial qcow2 files to avoid deleting user files
initial_qcow2_files=$(ls *.qcow2 2>/dev/null || true)

nix run .#nixosConfigurations.$hostname.config.system.build.vm -- $@

# Only remove newly created qcow2 files
for file in *.qcow2; do
  if [ -f "$file" ] && ! echo "$initial_qcow2_files" | grep -q "^$file$"; then
    rm "$file"
  fi
done 2>/dev/null || true
