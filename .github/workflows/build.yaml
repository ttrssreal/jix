name: Build

on:
  workflow_dispatch:
  pull_request:

jobs:
  build:
    strategy:
      matrix:
        os:
          - ubuntu-latest

    runs-on: ${{ matrix.os }}

    steps:
      - name: Free Disk Space (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true

      - name: Checkout
        uses: actions/checkout@v5.0.0

      - name: Install nix
        uses: DeterminateSystems/nix-installer-action@v20

      - name: Setup gha cache
        uses: DeterminateSystems/magic-nix-cache-action@v13

      - name: Setup buildtime-secrets-nix
        env:
          CI_KEY: ${{ secrets.CI_KEY }}
        run: |
          sudo \
            --preserve-env=CI_KEY \
            --preserve-env=GITHUB_WORKSPACE \
            -i sh -c '
              cd "$GITHUB_WORKSPACE" &&
              ./.github/ci.sh install
            '

      - name: Setup upterm session
        uses: owenthereal/action-upterm@v1

      - name: Build
        run: ./.github/ci.sh build
