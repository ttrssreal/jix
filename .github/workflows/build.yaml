name: Build

on:
  workflow_dispatch:
    inputs:
        job_name:
          description: "Dispatch this single job for testing"
          required: false
          type: string
  pull_request:

jobs:
  plan:
    runs-on: ubuntu-latest

    outputs:
      plan: ${{ steps.plan.outputs.plan }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5.0.0

      - name: Install nix
        uses: DeterminateSystems/nix-installer-action@v20

      - name: Calculate jobs
        id: plan
        run: |
          test_arg=()

          if [[ -n "${{ inputs.job_name }}" ]]; then
            test_arg+=(-t)
            test_arg+=("${{ inputs.job_name }}")
          fi

          ./.github/ci.py \
            -c ./.github/ci.yaml \
            "${test_arg[@]}" \
            plan build \
            >> "$GITHUB_OUTPUT"

  build:
    needs: plan
    strategy:
      matrix:
        os:
          - ubuntu-latest
        job-spec: ${{ fromJSON(needs.plan.outputs.plan) }}

    runs-on: ${{ matrix.os }}

    name: ${{ matrix.job-spec.name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5.0.0

      - name: Free Disk Space
        uses: wimpysworld/nothing-but-nix@v6

      - name: Setup tailscale (make cache reachable)
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Install nix
        uses: DeterminateSystems/nix-installer-action@v20

      - name: Setup Attic cache
        uses: ryanccn/attic-action@v0.4.0
        with:
          endpoint: https://ari.mudpuppy-cod.ts.net/nix-cache/
          cache: ${{ secrets.ATTIC_CACHE }}
          token: ${{ secrets.ATTIC_TOKEN }}

      - name: Write key to disk
        id: key_file
        env:
          CI_KEY: ${{ secrets.CI_KEY }}
        run: |
          key_file=$(mktemp)
          >"$key_file" echo "$CI_KEY" 
          >>"$GITHUB_OUTPUT" echo "key_file=$key_file"

      - name: Install buildtime-secrets-nix
        uses: ttrssreal/buildtime-secrets-nix-install-action@main
        with:
          ci-key-file: ${{ steps.key_file.outputs.key_file }}
          sops-file: secrets/buildtime.yaml

      - name: Build
        # capture logs to generate a summary
        run: ./.github/ci.py run ${{ matrix.job-spec.command }}
